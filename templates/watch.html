<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Player</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #222;
            color: white;
            font-family: Verdana, Geneva, Tahoma, sans-serif;
        }
        #videoPlayer {
            border-radius: 20px;
            width: 60%;
            max-height: 80vh;
            object-fit: contain;
        }
    </style>
</head>
<body>
    <div style="position: fixed; top: 10px; left: 10px;">
        <a href="/" style="text-decoration: none;">
            <button style="padding: 10px 20px; background-color: #222; color: #aaa; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Go to Main Page</button>
        </a>
    </div>
    <div style="position: fixed; bottom: 10px; left: 10px;">
        <a onclick="window.location.href = `/raw?${(new URLSearchParams(window.location.search)).toString()}`" style="text-decoration: none;">
            <button style="padding: 10px 20px; background-color: #222; color: #aaa; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Open raw video</button>
        </a>
    </div>
    <div style="position: fixed; top: 10px; right: 10px; color: #555;">
        YT-DLP version {{version}}
    </div>
    
    <video id="videoPlayer" controls onerror="handleVideoError()">
        <source id="videoSource" type="video/mp4">
        Your browser does not support the video tag.
    </video>
</body>
<script>
    function handleVideoError() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('url')) {
            const url = urlParams.get('url');
            urlParams.set('download', url);
            urlParams.delete('url');
            window.location.search = urlParams.toString();
        } else if (urlParams.has('v')) {
            const v = urlParams.get('v');
            urlParams.set('download', v);
            urlParams.delete('v');
            window.location.search = urlParams.toString();
        }
    }

    function checkVideoPayload() {
        console.log("Error");
        const videoPlayer = document.getElementById('videoPlayer');
        if (videoPlayer.duration === 0 || videoPlayer.videoWidth === 0 || videoPlayer.videoHeight === 0) {
            handleVideoError();
        }
    }

    function loadVideo() {
        const urlParams = new URLSearchParams(window.location.search);
        console.log(`/search?${(urlParams.toString())}`);
        fetch(`/search?${(urlParams.toString())}`)
            .then(response => response.text())
            .then(data => {
                console.log(data);
                const videoSource = document.getElementById('videoSource');
                videoSource.src = data;
                const videoPlayer = document.getElementById('videoPlayer');
                videoPlayer.load();
                console.log("Video loaded");
                setTimeout(() => {
                    checkVideoPayload();
                }, 2000);
            })
            .catch(error => {
                console.error('Error fetching video URL:', error);
                handleVideoError();
            });
    }
    document.addEventListener('DOMContentLoaded', loadVideo);
</script>
</html>