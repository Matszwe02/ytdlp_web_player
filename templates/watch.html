<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YT-DLP Player</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #222;
            color: white;
            font-family: Verdana, Geneva, Tahoma, sans-serif;
        }
        #videoPlayer {
            border-radius: 20px;
            width: 60vw;
            max-height: 80vh;
            object-fit: contain;
            border: 0.4vw solid black;
            box-shadow: 0 0 10vw black;
            z-index: 1;
        }
        .custom-loader
        {
            position: fixed;
            top: calc(50% - 7vw/2);
            left: calc(50% - 7vw/2);
            z-index: 2;
            width: 7vw;
            height: 7vw;
            border-radius: 50%;
            background: 
                radial-gradient(farthest-side,#F4F4F4 94%,#0000) top/16px 16px no-repeat,
                conic-gradient(#0000 30%,#F4F4F4);
            -webkit-mask: radial-gradient(farthest-side,#0000 calc(100% - 16px),#000 0);
            animation:s3 1s infinite linear;
            
            transition-duration: 1s;
        }

        @keyframes s3
        { 
            100%{transform: rotate(1turn)}
        }


    </style>
</head>
<body>
    <div style="position: fixed; top: 10px; left: 10px;">
        <a href="/" style="text-decoration: none;">
            <button style="padding: 10px 20px; background-color: #222; color: #aaa; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Go to Main Page</button>
        </a>
    </div>
    <div style="position: fixed; bottom: 10px; left: 10px;">
        <a onclick="window.location.href = `/raw?${(new URLSearchParams(window.location.search)).toString()}`" style="text-decoration: none;">
            <button style="padding: 10px 20px; background-color: #222; color: #aaa; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Open raw video</button>
        </a>
    </div>
    <div style="position: fixed; top: 10px; right: 10px; color: #555;">
        YT-DLP version {{version}}
    </div>
    
    <div style="position: relative; width: fit-content; height: fit-content;">
        <div class="custom-loader" id="videoLoader"></div>
        <video id="videoPlayer" onerror="handleVideoError()">
            <source id="videoSource" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    </div>
    
</body>
<script>
    function handleVideoError() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('url')) {
            const url = urlParams.get('url');
            urlParams.set('download', url);
            urlParams.delete('url');
            window.location.search = urlParams.toString();
        } else if (urlParams.has('v')) {
            const v = urlParams.get('v');
            urlParams.set('download', v);
            urlParams.delete('v');
            window.location.search = urlParams.toString();
        }
    }
    
    errorCount = 0;

    function checkVideoPayload() {
        console.log("Error");
        const videoPlayer = document.getElementById('videoPlayer');
        if (videoPlayer.duration === 0 || videoPlayer.videoWidth === 0 || videoPlayer.videoHeight === 0) {
            if (errorCount++ > 10)
                handleVideoError();
            setTimeout(() => {
                checkVideoPayload();
            }, 200);
        }
        else {
            const videoLoader = document.getElementById('videoLoader');
            videoLoader.style.opacity = 0;
            const videoPlayer = document.getElementById('videoPlayer');
            videoPlayer.controls = true;
                        setTimeout(() => {
                videoLoader.style.display = 'none';
            }, 1000);
        }
    }

    function loadVideo() {
        const urlParams = new URLSearchParams(window.location.search);
        console.log(`/search?${(urlParams.toString())}`);
        fetch(`/search?${(urlParams.toString())}`)
            .then(response => response.text())
            .then(data => {
                console.log(data);
                const videoSource = document.getElementById('videoSource');
                videoSource.src = data;
                const videoPlayer = document.getElementById('videoPlayer');
                videoPlayer.load();
                console.log("Video loaded");
                setTimeout(() => {
                    checkVideoPayload();
                }, 200);
            })
            .catch(error => {
                console.error('Error fetching video URL:', error);
                handleVideoError();
            });
    }
    document.addEventListener('DOMContentLoaded', loadVideo);
</script>
</html>